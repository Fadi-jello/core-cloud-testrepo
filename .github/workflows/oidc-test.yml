name: Test OIDC to Artifactory

on:
  workflow_dispatch:

jobs:
  test-artifactory-oidc:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: ⏳ Checkout repository
        uses: actions/checkout@v4

      - name: 🔐 Request GitHub OIDC token
        id: get_token
        run: |
          echo "Requesting GitHub OIDC token..."
          export REQUEST_URL="${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=https://github.com/Fadi-jello"
          TOKEN=$(curl -sLS "$REQUEST_URL" \
            -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" | jq -r '.value')
          echo "::add-mask::$TOKEN"
          echo "$TOKEN" > token.txt
          echo "✅ ID Token acquired"

      - name: 🧪 Decode JWT payload (for debug)
        run: |
          cut -d '.' -f2 < token.txt | tr -- '+/' '-_' | tr -d '=' | base64 -d | jq || echo "⚠️ Failed to decode"

      - name: 🔁 Send token to Artifactory
        run: |
          ART_URL="https://elinaf.jfrog.io/access/api/v1/oidc/token"
          PROVIDER_NAME="fadije"
          TOKEN=$(cat token.txt)

          curl -v -X POST "$ART_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "grant_type": "urn:ietf:params:oauth:grant-type:token-exchange",
              "subject_token_type": "urn:ietf:params:oauth:token-type:id_token",
              "subject_token": "'"$TOKEN"'",
              "provider_name": "'"$PROVIDER_NAME"'"
            }'
