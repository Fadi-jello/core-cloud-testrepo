name: Test OIDC to Artifactory

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  oidc-auth:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub OIDC Token
        id: auth
        run: |
          OIDC_TOKEN=$(curl -sLS $ACTIONS_ID_TOKEN_REQUEST_URL \
          -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" | jq -r '.value')
          
          echo "üîë Raw OIDC Token:"
          echo "$OIDC_TOKEN"
          
          echo "$OIDC_TOKEN" | jq -R 'split(".") | .[1] | @base64d | fromjson' > decoded.json
          cat decoded.json
          
          echo "$OIDC_TOKEN" > github_jwt.txt

          echo "üîê Requesting GitHub OIDC token..."
          export TOKEN=$(curl -sLS $ACTIONS_ID_TOKEN_REQUEST_URL \
            -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" | jq -r '.value')

          echo "$TOKEN" > github_jwt.txt

          echo "üì• Decoding JWT payload..."
          echo $TOKEN | cut -d '.' -f2 | base64 --decode | jq > decoded.json
          cat decoded.json
          echo $TOKEN

      - name: Exchange Token with Artifactory
        run: |
          echo "üîÅ Sending token to Artifactory..."
          
          ART_URL="https://elinaf.jfrog.io/access/api/v1/oidc/token"
          TOKEN=$(cat github_jwt.txt)

          curl -i -X POST "$ART_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "grant_type": "urn:ietf:params:oauth:grant-type:token-exchange",
              "subject_token": "'"$TOKEN"'",
              "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
              "provider_name": "fadije"
            }'
